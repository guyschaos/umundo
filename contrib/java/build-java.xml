<project name="umundo" default="jar">

<target name="compile" description="Compile the java code generated by SWIG.">
  <mkdir dir="${build.dir}/core/bindings/swig/java-class/" />
	<javac destdir="${build.dir}/core/bindings/swig/java-class/" debug="true" includeantruntime="false">
      <src path="${build.dir}/core/bindings/swig/java/" />
      <src path="${src.dir}/s11n/src/umundo-java/" />
      <classpath>
          <pathelement location="${src.dir}/contrib/java/lib/protobuf-java-2.4.1.jar"/>
      </classpath>      
  </javac>
</target>

<target name="jar" depends="compile" description="Create a bundle of the source code">

	<echo message="library output dir: ${lib.dir}"/>
	<echo message="source dir:         ${src.dir}"/>
	<echo message="build dir:          ${build.dir}"/>
	<echo message="build type:         ${build.type}"/>
	<echo message="jni library:        ${jnilib.file}"/>
	<echo message="fat jar:            ${fat.jar}"/>
	<echo message="dist dir:           ${dist.dir}"/>

	<!-- only include all JNI libraries in distribution builds -->
	<condition property="include.all.jni">
		<equals arg1="${fat.jar}" arg2="ON"/>
	</condition>

	<!-- flatten all JNI libraries for inclusion into the fat JAR -->
	<fileset id="jni.desktop" dir="${dist.dir}">
		<include name="**/*Swig*.jnilib" if="${include.all.jni}"/>
		<include name="**/*Swig*.so" if="${include.all.jni}"/>
		<include name="**/*Swig*.dll" if="${include.all.jni}"/>
		<exclude name="cross-compiled/**"/>
		<!-- do not include debug builds in fat jar -->
		<exclude name="**/*undocoreSwigSwig_d*"/>
		<exclude name="**/*undocoreSwig64_d*"/>
	</fileset>
	<mkdir dir="${dist.dir}/jni" />
	<copy todir="${dist.dir}/jni" flatten="true">
		<fileset refid="jni.desktop" />
	</copy>

	<!-- delete an eventual old jar -->
	<delete dir="${lib.dir}/umundocore.jar" />
	
	<!-- build new jar -->
	<jar destfile="${lib.dir}/umundocore.jar">
    <fileset dir="${lib.dir}/" >
      <include name="${jnilib.file}" />
    </fileset>
    <fileset dir="${build.dir}/core/bindings/swig/java-class/" >
      <include name="**/*.class" />
    </fileset>
    <fileset dir="${build.dir}/core/bindings/swig/java/" >
      <include name="**/*.java" />
    </fileset>
    <fileset dir="${src.dir}/s11n/src/umundo-java/" >
      <include name="**/*.java" />
    </fileset>
    <fileset dir="${dist.dir}/jni" >
      <include name="**/*" />
    </fileset>
	</jar>
	<delete dir="${dist.dir}/jni" />
	
	<!-- Test whether the jar can be used -->
	<javac classpath="${lib.dir}/umundocore.jar" srcdir="test/" includeantruntime="false" />
	<java classpath="${lib.dir}/umundocore.jar:test" classname="TestJNILoad" />
	<delete file="test/TestJNILoad.class" />

</target>

</project>
